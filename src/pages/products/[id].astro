---
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  function parseCSV(csv) {
    const lines = csv.trim().split('\n');
    const headers = lines.shift().split(',').map(h => h.trim().replace(/"/g, '').replace(/\uFEFF/g, ''));
    
    return lines.map(line => {
      const obj = {};
      const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
      
      headers.forEach((header, i) => {
        let value = (values[i] || '').trim();
        if (value.startsWith('"') && value.endsWith('"')) {
          value = value.slice(1, -1);
        }
        obj[header] = value.replace(/""/g, '"');
      });
      return obj;
    });
  }

  const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vRrSp2-QTxSJrbnisNOld949NtzjRZURm1_UeJbw9VgoYtHZshvzbfyS1B2Ma7cTiknzaq1WJP0na6o/pub?output=csv');
  const csv = await response.text();
  const products = parseCSV(csv);

  return products.filter(p => p['شماره محصول']).map(product => {
    return {
      params: { id: product['شماره محصول'] },
      props: { product },
    };
  });
}

const { id } = Astro.params;
const { product } = Astro.props;
---
<Layout title={product['نام']}>
  <main class="product-page">
    <a href="/" class="back-link">&larr; بازگشت به لیست محصولات</a>
    <h1>{product['نام']}</h1>
    <div class="product-layout">
      <div class="product-media">
        {product['لینک ویدیو معرفی'] && (
          <video controls preload="metadata">
            <source src={product['لینک ویدیو معرفی']} type="video/mp4">
            Your browser does not support the video tag.
          </video>
        )}
        <img src={product['لینک تصویر']} alt={product['نام']} />
      </div>
      <div class="product-details">
        <p class="price">{parseInt(product['قیمت ماهانه']).toLocaleString('fa-IR')} تومان / ماهانه</p>
        <p class="description">{product['توضیحات']}</p>
        <div class="buttons">
          <a href={product['زرین لینک']} target="_blank" class="btn btn-payment">پرداخت و فعالسازی</a>
          <a href="tel:+989114618006" class="btn btn-contact">تماس</a>
          <a href="YOUR_SUPPORT_LINK" class="btn btn-support">پشتیبانی</a>
        </div>
      </div>
    </div>
  </main>
</Layout>

<style>
  .product-page {
    max-width: 1000px;
    margin: 2rem auto;
    padding: 2rem;
    background: rgba(26, 26, 26, 0.8);
    border-radius: 16px;
    backdrop-filter: blur(10px);
  }
  .back-link {
    display: inline-block;
    margin-bottom: 2rem;
    color: var(--primary-color);
    text-decoration: none;
  }
  .product-layout {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
  }
  @media (min-width: 768px) {
    .product-layout {
      grid-template-columns: 1fr 1fr;
    }
  }
  .product-media video, .product-media img {
    width: 100%;
    border-radius: 8px;
  }
  .product-media video {
    margin-bottom: 1rem;
  }
  .price {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--secondary-color);
    margin-bottom: 1rem;
  }
  .description {
    font-size: 1.1rem;
    line-height: 1.8;
    opacity: 0.9;
    margin-bottom: 2rem;
  }
  .buttons {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  .btn {
    text-decoration: none;
    color: var(--bg-color);
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
    font-weight: 600;
    transition: opacity 0.3s ease;
  }
  .btn:hover {
      opacity: 0.9;
  }
  .btn-payment {
    background-color: var(--secondary-color);
  }
  .btn-contact {
    background-color: var(--primary-color);
  }
  .btn-support {
    background-color: #6c757d;
  }
</style>
